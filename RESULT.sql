-- RESULT REPRO

WITH DATE_PED AS (SELECT DISTINCT ID_PEDIDO
           FROM PEDID
           WHERE
           PEDDTBAIXA BETWEEN
             DATEADD(MONTH, -5, CURRENT_DATE - EXTRACT(DAY FROM CURRENT_DATE) + 1) AND
                                 'YESTERDAY' OR  PEDDTBAIXA 
                                 BETWEEN DATEADD(MONTH, -5,DATEADD(YEAR, -1, CURRENT_DATE) - EXTRACT(DAY FROM CURRENT_DATE) + 1) AND DATEADD(YEAR, -1, CURRENT_DATE)),
                  
  --  FILTRA CFOPS DE VENDA  

FIS AS (SELECT FISCODIGO FROM TBFIS WHERE FISTPNATOP IN ('V','R','SR')),
                
                  
      PED AS (SELECT P.ID_PEDIDO,
                      PEDDTBAIXA,
                       P.CLICODIGO
        FROM PEDID P
        INNER JOIN DATE_PED DT ON P.ID_PEDIDO=DT.ID_PEDIDO
        WHERE  PEDSITPED<>'C' AND PEDLCFINANC IN ('S', 'L','N')),
        
CLI AS (SELECT DISTINCT CLICODIGO,GCLCODIGO FROM CLIEN WHERE CLICLIENTE='S')         
        
  
-- SELECT FINAL

SELECT EXTRACT(MONTH  FROM PEDDTBAIXA) MES,
        EXTRACT(YEAR  FROM PEDDTBAIXA) ANO,
         P.CLICODIGO,
          GCLCODIGO,
           SUM(PDPUNITLIQUIDO*PDPQTDADE) VRVENDA
            FROM PDPRD PD
             INNER JOIN PED P ON P.ID_PEDIDO=PD.ID_PEDIDO
              INNER JOIN FIS F ON F.FISCODIGO=PD.FISCODIGO
               LEFT JOIN CLI C ON C.CLICODIGO=P.CLICODIGO
                GROUP BY 1,2,3,4